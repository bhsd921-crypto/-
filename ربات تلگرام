import os
import requests
from datetime import datetime
from flask import Flask, request

app = Flask(__name__)
TOKEN = os.environ.get("TOKEN", "8284113641:AAF-SS_GX-wMlbMR391NyfMyB0xoBTEiPf4")
URL = f"https://api.telegram.org/bot{TOKEN}/"

def get_time():
    return datetime.now().strftime("ğŸ“… ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ²: %Y/%m/%d")

def get_hour():
    return datetime.now().strftime("â° Ø³Ø§Ø¹Øª Ø§Ù„Ø§Ù†: %H:%M:%S")

def calculate_age(birth_date):
    try:
        today = datetime.now().date()
        birth = datetime.strptime(birth_date, "%Y/%m/%d").date()
        age = today - birth
        years = age.days // 365
        months = (age.days % 365) // 30
        days = (age.days % 365) % 30
        return f"ğŸ‚ Ø³Ù† ØªÙˆ: {years} Ø³Ø§Ù„, {months} Ù…Ø§Ù‡, {days} Ø±ÙˆØ²"
    except:
        return "âŒ ØªØ§Ø±ÛŒØ® Ø±Ùˆ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ù…Ø«Ø§Ù„: 1385/03/10)"

@app.route('/')
def home():
    return "Ø±Ø¨Ø§Øª ÙØ¹Ø§Ù„ Ø§Ø³Øª! ğŸ¤–"

def process_update(update):
    message = update.get("message", {})
    text = message.get("text", "")
    chat_id = message.get("chat", {}).get("id")
    
    if not text or not chat_id:
        return
    
    if text == "/start":
        response = "ğŸ¤– Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\n\nâœ¨ Ø§Ù…Ú©Ø§Ù†Ø§Øª:\nâ€¢ ØªØ§Ø±ÛŒØ®\nâ€¢ Ø³Ø§Ø¹Øª\nâ€¢ /age [ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯]"
    elif text == "ØªØ§Ø±ÛŒØ®":
        response = get_time()
    elif text == "Ø³Ø§Ø¹Øª":
        response = get_hour()
    elif text.startswith("/age"):
        birth_date = text.replace("/age", "").strip()
        response = calculate_age(birth_date) if birth_date else "âŒ Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
    else:
        response = "ğŸ¤– Ø¯Ø³ØªÙˆØ± Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡!\nØ¨Ø±Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ /start Ø±Ø§ Ø¨ÙØ±Ø³ØªÛŒØ¯."
    
    requests.post(URL + "sendMessage", json={"chat_id": chat_id, "text": response})

@app.route('/webhook', methods=['POST'])
def webhook():
    update = request.json
    process_update(update)
    return "OK"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
