import os
import requests
from datetime import datetime
from flask import Flask, request

app = Flask(__name__)
TOKEN = os.environ.get("TOKEN", "8284113641:AAF-SS_GX-wMlbMR391NyfMyB0xoBTEiPf4")
URL = f"https://api.telegram.org/bot{TOKEN}/"

def get_time():
    return datetime.now().strftime("📅 تاریخ امروز: %Y/%m/%d")

def get_hour():
    return datetime.now().strftime("⏰ ساعت الان: %H:%M:%S")

def calculate_age(birth_date):
    try:
        today = datetime.now().date()
        birth = datetime.strptime(birth_date, "%Y/%m/%d").date()
        age = today - birth
        years = age.days // 365
        months = (age.days % 365) // 30
        days = (age.days % 365) % 30
        return f"🎂 سن تو: {years} سال, {months} ماه, {days} روز"
    except:
        return "❌ تاریخ رو به درستی وارد کن (مثال: 1385/03/10)"

@app.route('/')
def home():
    return "ربات فعال است! 🤖"

def process_update(update):
    message = update.get("message", {})
    text = message.get("text", "")
    chat_id = message.get("chat", {}).get("id")
    
    if not text or not chat_id:
        return
    
    if text == "/start":
        response = "🤖 به ربات خوش آمدید!\n\n✨ امکانات:\n• تاریخ\n• ساعت\n• /age [تاریخ تولد]"
    elif text == "تاریخ":
        response = get_time()
    elif text == "ساعت":
        response = get_hour()
    elif text.startswith("/age"):
        birth_date = text.replace("/age", "").strip()
        response = calculate_age(birth_date) if birth_date else "❌ لطفاً تاریخ تولد را وارد کنید"
    else:
        response = "🤖 دستور ناشناخته!\nبرای راهنما /start را بفرستید."
    
    requests.post(URL + "sendMessage", json={"chat_id": chat_id, "text": response})

@app.route('/webhook', methods=['POST'])
def webhook():
    update = request.json
    process_update(update)
    return "OK"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
